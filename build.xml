<project name="QwStoretEtl" default="default">
	<target name="default" depends="buildPackage, scpScript, dos2unix, qwStoretEtl"/>

	<target name="dev" depends="buildPackage, runPackage"/>

	<target name="ci" depends="buildPackage, compilePackageEmptyCiDB, runPackage"/>

	<target name="buildPackage">
		<echo>Rebuiling the etl database pacakge and body</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${wqp_storet_username}/${wqp_storet_password}@${instance}"/>
			<arg value="@${basedir}/create_storet_objects.sql"/>
		</exec>
	</target>
	
	<target name="buildPackageEros">
		<echo>Rebuiling the etl database package and body at EROS</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${wqp_storet_username}/${wqp_storet_password}@${instance}"/>
			<arg value="@${basedir}/create_storet_objects_stage.sql"/>
		</exec>
	</target>
	
	<target name="compilePackageEmptyCiDB">
		<echo>Rebuiling the etl database pacakge and body</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${wqp_storet_username}/${wqp_storet_password}@${instance}"/>
			<arg value="@${basedir}/emptyCiDB.sql"/>
		</exec>
	</target>
	
	<target name="runPackage">
		<echo>Running the main ETL Package</echo>
		<exec executable="sqlplus" failonerror="true">
			<arg value="${wqp_storet_username}/${wqp_storet_password}@${instance}"/>
			<arg value="@${basedir}/runPackage.sql"/>
			<arg value="${success_notify}"/>
			<arg value="${failure_notify}"/>
		</exec>
	</target>
	
	<target name="scpScript">
		<echo>Copy the script to ${storet_host}</echo>
		<scp file="storet_auto_load.bash" todir="storet_user:${storet_password}@${storet_host}:/home/storet_user" trust="true"/>
	</target>

	<target name="scpScriptStage">
		<echo>Copy the script to ${storet_host}</echo>
		<scp file="storet_dump.sh" todir="storet_user:${storet_password}@${storet_host}:/home/storet_user" trust="true"/>
	</target>

	<target name="dos2unix">
		<echo>Fix cr/lf</echo>
		<sshexec host="${storet_host}"
			trust="true"
			username="storet_user"
			password="${storet_password}"
			command="dos2unix storet_auto_load.bash"/>
	</target>
	
	<target name="dos2unixStage">
		<echo>Fix cr/lf</echo>
		<sshexec host="${storet_host}"
			trust="true"
			username="storet_user"
			password="${storet_password}"
			command="dos2unix storet_dump.sh"/>
	</target>
	
	<target name="qwStoretEtl">
		<echo>Run the script</echo>
		<sshexec host="${storet_host}"
			trust="true"
			failonerror="true"
			username="storet_user"
			password="${storet_password}"
			command="bash -e storet_auto_load.bash"
		/>
	</target>
	
	<target name="qwStoretEtlStage">
		<echo>Run the script</echo>
		<sshexec host="${storet_host}"
			trust="true"
			failonerror="true"
			username="storet_user"
			password="${storet_password}"
			command="bash -e storet_dump.sh"
		/>
	</target>
	
	<target name="importViaDataPump">
		<echo>Using impdp to load the storetw schema</echo>
		<exec executable="$ORACLE_HOME/bin/impdp" failonerror="true">
			<arg value="userid=storetw/***REMOVED***@dbstage.er.usgs.gov"/>
			<arg value="directory=pdc_temp"/>
			<arg value="dumpfile=stormodb_shire_storetw_%u.cdmp"/>
			<arg value="logfile=stormod_shire_storetw_impdp.log"/>
			<arg value='"tables=(FA_STATION,FA_REGULAR_RESULT,DI_ACTIVITY_MATRIX,DI_ACTIVITY_MEDIUM,DI_CHARACTERISTIC,DI_GEO_COUNTY,DI_GEO_STATE,DI_ORG,DI_STATN_TYPES, LU_MAD_HMETHOD,LU_MAD_HDATUM,LU_MAD_VMETHOD,LU_MAD_VDATUM,MT_WH_CONFIG)"'/>
			<arg value="EXCLUDE=constraint,index,grant"/>
		</exec>
	</target>
	
</project>